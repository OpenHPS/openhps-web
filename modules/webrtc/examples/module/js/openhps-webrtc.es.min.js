import*as e from"./openhps-core.es.min.js";var t={d:(e,i)=>{for(var r in i)t.o(i,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:i[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},i={};t.d(i,{L:()=>VideoSource});const r=(e=>{var i={};return t.d(i,e),i})({DataFrame:()=>e.DataFrame,DataObject:()=>e.DataObject,Matrix3:()=>e.Matrix3,SerializableArrayMember:()=>e.SerializableArrayMember,SerializableMember:()=>e.SerializableMember,SerializableObject:()=>e.SerializableObject,SourceNode:()=>e.SourceNode,TimeService:()=>e.TimeService,TimeUnit:()=>e.TimeUnit});function s(e,t,i,r){var s,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(a=(o<3?s(a):o>3?s(t,i,a):s(t,i))||a);return o>3&&a&&Object.defineProperty(t,i,a),a}function o(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}Object.create;Object.create;let a=class CameraObject extends r.DataObject{get focalLength(){if(this.cameraMatrix)return[this.cameraMatrix.elements[0],this.cameraMatrix.elements[4]]}get principalPoint(){if(this.cameraMatrix)return[this.cameraMatrix.elements[6],this.cameraMatrix.elements[7]]}get aspect(){return this.width/this.height}get rows(){return this.height}set rows(e){this.height=e}get cols(){return this.width}set cols(e){this.width=e}constructor(e,t,i,r){var s;super(e,t),this.colorOrder=n.RGB,this.width=i||0,this.height=r||0,this.distortionCoefficients=null!==(s=this.distortionCoefficients)&&void 0!==s?s:[0,0,0,0,0]}};var n;s([(0,r.SerializableMember)(),o("design:type",Number)],a.prototype,"width",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],a.prototype,"height",void 0),s([(0,r.SerializableArrayMember)(Number),o("design:type",Array)],a.prototype,"distortionCoefficients",void 0),s([(0,r.SerializableMember)(),o("design:type",r.Matrix3)],a.prototype,"cameraMatrix",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],a.prototype,"fps",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],a.prototype,"colorOrder",void 0),a=s([(0,r.SerializableObject)(),o("design:paramtypes",[String,String,Number,Number])],a),function(e){e[e.RGB=0]="RGB",e[e.BGR=1]="BGR",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.RGBA=3]="RGBA",e[e.BGRA=4]="BGRA"}(n||(n={}));let h=class ImageFrame extends r.DataFrame{get rows(){return this.height}set rows(e){this.height=e}get cols(){return this.width}set cols(e){this.width=e}get source(){return super.source}set source(e){super.source=e}};s([(0,r.SerializableMember)(),o("design:type",Object)],h.prototype,"image",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],h.prototype,"height",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],h.prototype,"width",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],h.prototype,"fourcc",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],h.prototype,"fps",void 0),h=s([(0,r.SerializableObject)()],h);let d=class VideoFrame extends h{};d=s([(0,r.SerializableObject)()],d);class VideoSource extends r.SourceNode{constructor(e){super(e),this.frame=0,this.options.source=this.options.source||new a(this.uid,void 0),this.once("build",this._onBuild.bind(this)),this.once("destroy",this.stop.bind(this))}_onBuild(){return new Promise(((e,t)=>{if(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,void 0===navigator.getUserMedia)throw new Error("getUserMedia is not supported by the browser!");this.options.canvas?"string"==typeof this.options.canvas?this.canvas=document.getElementById(this.options.canvas):this.canvas=this.options.canvas:(this.canvas=document.createElement("canvas"),this.canvas.id=`_OpenHPS-${this.uid}`,this.canvas.setAttribute("style","display: none"),document.body.append(this.canvas)),this.context=this.canvas.getContext("2d"),this.options.videoSource?this.load(this.options.videoSource).then((()=>{this.options.autoPlay&&this.play(),e()})).catch(t):e()}))}reset(){this.frame=0}play(){let e=!1;if(!this.video)throw new Error("No video source loaded!");return this.video.play().then((()=>{e=!0})).catch((e=>{this.logger("error",e.name+" : "+e.message,e)})),this.timer=setInterval((()=>{!e&&this.options.throttleRead||(e=!1,this._readFrame().then((t=>t?(this.options.throttlePush||(e=!0),this.push(t)):clearInterval(this.timer))).then((()=>{this.options.throttlePush&&(e=!0)})).catch((e=>{this.logger("error","Unable to read video frame!",e)})))}),-1===this.options.fps?0:1e3/this.options.fps),this.start=Date.now(),this.timer}stop(){this.pause(),this.stream.getTracks().forEach((e=>{e.stop()}))}pause(){this.video.pause(),this.timer&&clearInterval(this.timer)}get currentFrameCount(){return this.frame}get totalFrameCount(){return this.totalFrames}get actualFPS(){return Math.round(this.frame/((Date.now()-this.start)/1e3)*100)/100}onPull(){return this._readFrame()}_readFrame(){return new Promise(((e,t)=>{const i=new d;i.source=this.source,i.fps=this.options.fps,this.readFrame().then((t=>{if(!t)return e(void 0);this.frame++,i.phenomenonTimestamp=r.TimeUnit.SECOND.convert(this.frame*(1/i.fps),r.TimeService.getUnit()),i.rows=this.options.height||t.height,i.cols=this.options.width||t.width,i.image=t,e(i)})).catch(t)}))}load(e){return new Promise(((t,i)=>{this.video="string"==typeof e?document.getElementById(e):e,navigator.getUserMedia({video:this.options,audio:this.options.audio},(e=>{this.stream=e,this.video.srcObject=e,this.video.onloadedmetadata=()=>{this.options.height=this.video.videoHeight,this.options.width=this.video.videoWidth,this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight,t()}}),(e=>{this.logger("error",e.name+": "+e.message,e),i(e)}))}))}readFrame(){return new Promise(((e,t)=>{try{if(this.video.readyState===this.video.HAVE_ENOUGH_DATA){this.context.drawImage(this.video,0,0,this.canvas.width,this.canvas.height);e(this.context.getImageData(0,0,this.canvas.width,this.canvas.height))}else e(void 0)}catch(e){t(e)}}))}}var c=i.L;export{c as VideoSource};
//# sourceMappingURL=openhps-webrtc.es.min.js.map